<!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><html><head><title>Chapter&#xA0;12.&#xA0;3D Rigid-Body Simulator</title><link rel="stylesheet" type="text/css" href="core.css"><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"><link rel="up" href="pt02.html" title="Part&#xA0;II.&#xA0;Rigid-Body Dynamics"><link rel="prev" href="ch11.html" title="Chapter&#xA0;11.&#xA0;Rotation in 3D Rigid-Body Simulators"><link rel="next" href="ch13.html" title="Chapter&#xA0;13.&#xA0;Connecting Objects"></head><body>
         
        <script>
        function ok(){ 
            window.gggs()
            return;
            //$('#musicPlayer').parent().remove();
            //speakTransportPanelDialogV2.closeEmoteDialog()
            //speakTransportPanelDialog.closeEmoteDialog()
            //
            debugger
            let url = 'http://127.0.0.1:8080/uploads/extracted/' +
             'Crazy Rich Asians  Kevin Kwanepub/' +
              'jsonSets/OEBPS/Kwan_9780385536981_epub_prl_r1.htm.html.sentences.json'
            speakTransportPanelDialogV2.sideLoadSentences2(null, null, null, url)
            
        }
        setTimeout(ok, 1500)
        </script>
        <div style="background:white">````````</div><section class="chapter" title="Chapter&#xA0;12.&#xA0;3D Rigid-Body Simulator" epub:type="chapter" id="d_rigid-body_simulator-id1"><div class="titlepage"><div><div><h2 class="title"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">1</span><span sentence-index="6878" class="highlight2">Chapter&#xA0;12.&#xA0;3D  Rigid-Body  Simulator</span></span></h2></div></div></div><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">2</span><span sentence-index="6879" class="highlight3">In  this  chapter  </span></span><a id="I_indexterm6_id332372" class="indexterm"></a><a id="si12.0" class="indexterm"></a><a id="ri12.0" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6882</span><span sentence-index="6882" class="highlight4">we&apos;ll  show  you  how  to  make  the  leap  from  2D  to  3D  by  implementing  a  rigid-body        simulation  of  an  airplane. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">6</span><span sentence-index="6883" class="highlight2"> Specifically,  this  is  a  simulation  of  the  hypothetical  airplane  model        that  we&apos;ll  discuss  extensively  in  </span></span></a><a class="xref" href="ch15.html" title="Chapter&#xA0;15.&#xA0;Aircraft"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">7</span><span sentence-index="6884" class="highlight3">Chapter&#xA0;15</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6885</span><span sentence-index="6885" class="highlight4"> . </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6886</span><span sentence-index="6886" class="highlight2">  This  airplane  is  of  typical        configuration  with  its  large  wings  forward,  its  elevators  aft,  a  single  vertical  tail,  and  plain        flaps  fitted  on  the  wings.</span></span></p><p><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6888</span><span sentence-index="6888" class="highlight3">As  with  the  2D  simulator  in  previous  chapters,  we&apos;ll  concentrate  on  the  code  that  implements        the  physics  part  of  the  simulator  and  not  the  platform-specific  GUI  aspects  of  the        simulations.</span></span></p><p><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6890</span><span sentence-index="6890" class="highlight4">As  in  2D,  there  are  four  main  elements  to  this  3D  simulation&#x2014;the  model,  integrator,  user        input,  and  rendering. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6891</span><span sentence-index="6891" class="highlight2">  Remember,  the  model  refers  to  your  idealization  of  the  thing&#x2014;an  airplane,        in  this  case&#x2014;that  you  are  trying  to  simulate,  while  the  integrator  refers  to  the  method  by  which        you  integrate  the  differential  equations  of  motion. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6892</span><span sentence-index="6892" class="highlight3">  These  two  elements  take  care  of  most  of  the        physics  of  the  simulation. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6893</span><span sentence-index="6893" class="highlight4">  The  user  input  and  rendering  elements  refer  to  how  you&apos;ll  allow  the        user  to  interact  with  and  view  your  simulation.</span></span></p><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">18</span><span sentence-index="6895" class="highlight2">In  this  simulation,  the  world  </span></span><a id="I_indexterm6_id332446" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6896</span><span sentence-index="6896" class="highlight3">coordinate  system  has  its  positive  x-axis  pointing  into  the  screen,  its  positive        y-axis  pointing  to  the  left  of  your  screen,  and  the  positive  z-axis  pointing  up. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6897</span><span sentence-index="6897" class="highlight4">  Also,  the        local,  or  body-fixed,  coordinate  system  has  its  positive  x-axis  pointing  toward  the  front  of  the        airplane,  its  positive  y-axis  pointing  to  the  port  side  (left  side),  and  its  positive  z-axis        pointing  up. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6898</span><span sentence-index="6898" class="highlight2">  Since  this  is  a  3D  simulation  of  an  airplane,  once  you  get  it  running,  you&apos;ll  be        able  to  fly  in  any  direction,  looping,  banking,  diving,  and  climbing,  or  performing  any  other        aerobatic  maneuver  you  desire.</span></span></a></p><div class="sect1" title="Model"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="model-id1"><a id="I_indexterm6_id332446" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">24</span><span sentence-index="6901" class="highlight3">Model</span></span></a></h2></div></div></div><p><a id="I_indexterm6_id332446" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">26</span><span sentence-index="6903" class="highlight4">One  of  the  most  </span></span></a><a id="th12.1" class="indexterm"></a><a id="mo12.1" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6905</span><span sentence-index="6905" class="highlight2">important  aspects  of  this  simulation  is  the  flight  model. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">29</span><span sentence-index="6906" class="highlight3"> We&apos;ll  spend  all  of  </span></span></a><a class="xref" href="ch15.html" title="Chapter&#xA0;15.&#xA0;Aircraft"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">30</span><span sentence-index="6907" class="highlight4">Chapter&#xA0;15</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6908</span><span sentence-index="6908" class="highlight2">  discussing  the  physics  behind  this  flight  model,  so  we  won&apos;t  include            that  discussion  here  except  to  introduce  a  few  key  bits  of  code.</span></span></p><p><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6910</span><span sentence-index="6910" class="highlight3">To  implement  the  flight  model,  you  first  need  to  prepare  a  rigid-body  structure  to            encapsulate  all  of  the  data  required  to  completely  define  the  state  of  the  rigid  body  at  any            instant  during  the  simulation. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">34</span><span sentence-index="6911" class="highlight4"> We&apos;ve  defined  a  structure  called  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">34</span><span sentence-index="6911" class="highlight2">RigidBody</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">34</span><span sentence-index="6911" class="highlight3"> for  this  purpose:</span></span></p><a id="I_programlisting6_id332530"><pre class="programlisting">typedef struct _RigidBody {

     float         fMass;           // total mass
     Matrix3x3     mInertia;        // mass moment of inertia
                                    // in body coordinates

     Matrix3x3     mInertiaInverse; // inverse of mass moment of inertia
     Vector        vPosition;       // position in earth coordinates
     Vector        vVelocity;       // velocity in earth coordinates
     Vector        vVelocityBody;   // velocity in body coordinates
     Vector        vAngularVelocity;// angular velocity in body coordinates
     Vector        vEulerAngles;    // Euler angles in body coordinates
     float         fSpeed;          // speed (magnitude of the velocity)
     Quaternion    qOrientation;    // orientation in earth coordinates
     Vector        vForces;         // total force on body
     Vector        vMoments;        // total moment (torque) on body
} RigidBody, *pRigidBody;</pre></a><p><a id="I_programlisting6_id332530"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">37</span><span sentence-index="6914" class="highlight4">You&apos;ll  notice  that  it  is  very  similar  to  the  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">37</span><span sentence-index="6914" class="highlight2">RigidBody2D</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6914</span><span sentence-index="6914" class="highlight3">  structure  that  we  used  in  the  2D  hovercraft  simulation. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">38</span><span sentence-index="6915" class="highlight4"> One            significant  difference,  however,  is  that  in  the  2D  case,  </span></span></a><a id="I_indexterm6_id332556" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">39</span><span sentence-index="6916" class="highlight2">orientation  was  a  single  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">39</span><span sentence-index="6916" class="highlight3">float</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">39</span><span sentence-index="6916" class="highlight4"> value,  and  now            in  3D  it&apos;s  a  quaternion  of  type  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">39</span><span sentence-index="6916" class="highlight2">Quaternion</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6917</span><span sentence-index="6917" class="highlight3"> . </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">41</span><span sentence-index="6918" class="highlight4"> We  discussed            the  use  of  quaternions  for  tracking  rigid-body  orientation  in  the  previous  chapter,  and  </span></span></a><a class="xref" href="apc.html" title="Appendix&#xA0;C.&#xA0;Quaternion Operations"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">42</span><span sentence-index="6919" class="highlight2">Appendix&#xA0;C</span></span></a><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">42</span><span sentence-index="6919" class="highlight3"> contains  a  complete  definition  of  the  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">42</span><span sentence-index="6919" class="highlight4">Quaternion</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6920</span><span sentence-index="6920" class="highlight2">  class.</span></span></p><p><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6922</span><span sentence-index="6922" class="highlight3">The  next  step  in  defining  the  flight  model  is  to  prepare  an  initialization  function  to            initialize  the  airplane  at  the  start  of  the  simulation. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">46</span><span sentence-index="6923" class="highlight4"> For  this  purpose,  we&apos;ve  prepared  a            function  called  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">46</span><span sentence-index="6923" class="highlight2">InitializeAirplane</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">46</span><span sentence-index="6923" class="highlight3">:</span></span></p><a id="I_programlisting6_id332603"><pre class="programlisting">RigidBody    Airplane;    // global variable representing the airplane
.
.
.

void     InitializeAirplane(void)
{
     float iRoll, iPitch, iYaw;

     // Set initial position
     Airplane.vPosition.x = &#x2212;5000.0f;
     Airplane.vPosition.y = 0.0f;
     Airplane.vPosition.z = 2000.0f;

     // Set initial velocity
     Airplane.vVelocity.x = 60.0f;
     Airplane.vVelocity.y = 0.0f;
     Airplane.vVelocity.z = 0.0f;
     Airplane.fSpeed = 60.0f;

     // Set initial angular velocity
     Airplane.vAngularVelocity.x = 0.0f;
     Airplane.vAngularVelocity.y = 0.0f;
     Airplane.vAngularVelocity.z = 0.0f;

     // Set the initial thrust, forces, and moments
     Airplane.vForces.x = 500.0f;
     Airplane.vForces.y = 0.0f;
     Airplane.vForces.z = 0.0f;
     ThrustForce = 500.0;

     Airplane.vMoments.x = 0.0f;
     Airplane.vMoments.y = 0.0f;
     Airplane.vMoments.z = 0.0f;

     // Zero the velocity in body space coordinates
     Airplane.vVelocityBody.x = 0.0f;
     Airplane.vVelocityBody.y = 0.0f;
     Airplane.vVelocityBody.z = 0.0f;

     // Set these to false at first,
     // you can control later using the keyboard
     Stalling = false;
     Flaps = false;

     // Set the initial orientation
     iRoll = 0.0f;
     iPitch = 0.0f;
     iYaw = 0.0f;
     Airplane.qOrientation = MakeQFromEulerAngles(iRoll, iPitch, iYaw);

     // Now go ahead and calculate the plane&apos;s mass properties
     CalcAirplaneMassProperties();
}</pre></a><p><a id="I_programlisting6_id332603"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">49</span><span sentence-index="6926" class="highlight4">This  function  sets  the  initial  location,  speed,  attitude,  and  thrust  for  the  airplane  and            goes  on  to  calculate  its  mass  properties  by  making  a  call  to  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">49</span><span sentence-index="6926" class="highlight2">CalcAirplaneMassProperties</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6926</span><span sentence-index="6926" class="highlight3"> . </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">50</span><span sentence-index="6927" class="highlight4"> You&apos;ll  see  much  more  of  this  function  in  </span></span></a><a class="xref" href="ch15.html" title="Chapter&#xA0;15.&#xA0;Aircraft"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">51</span><span sentence-index="6928" class="highlight2">Chapter&#xA0;15</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6929</span><span sentence-index="6929" class="highlight3"> ,  so  we  won&apos;t  show  the  whole  thing  here. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">53</span><span sentence-index="6930" class="highlight4"> We  do  want  to  point  out  a            portion  of  the  code  that  is  distinctly  different  from  what  you  do  in  a  2D  simulation,  and            that&apos;s  the  calculation  of  the  moment  of  </span></span><a id="I_indexterm6_id332637" class="indexterm"></a><a id="I_indexterm6_id332647" class="indexterm"></a><a id="I_indexterm6_id332657" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">56</span><span sentence-index="6933" class="highlight2">inertia  tensor:</span></span></a></p><a id="I_programlisting6_id332669"><pre class="programlisting">void     CalcAirplaneMassProperties(void)
{
     .
     .
     .

     // Now calculate the moments and products of inertia for the
     // combined elements.
     // (This inertia matrix (tensor) is in body coordinates)
     Ixx = 0;     Iyy = 0;     Izz = 0;
     Ixy = 0;     Ixz = 0;     Iyz = 0;
     for (i = 0; i&lt; 8; i++)
     {
          Ixx += Element[i].vLocalInertia.x + Element[i].fMass *
                 (Element[i].vCGCoords.y*Element[i].vCGCoords.y +
                  Element[i].vCGCoords.z*Element[i].vCGCoords.z);
          Iyy += Element[i].vLocalInertia.y + Element[i].fMass *
                 (Element[i].vCGCoords.z*Element[i].vCGCoords.z +
                  Element[i].vCGCoords.x*Element[i].vCGCoords.x);
          Izz += Element[i].vLocalInertia.z + Element[i].fMass *
                 (Element[i].vCGCoords.x*Element[i].vCGCoords.x +
                  Element[i].vCGCoords.y*Element[i].vCGCoords.y);
          Ixy += Element[i].fMass * (Element[i].vCGCoords.x *
                 Element[i].vCGCoords.y);
          Ixz += Element[i].fMass * (Element[i].vCGCoords.x *
                 Element[i].vCGCoords.z);
          Iyz += Element[i].fMass * (Element[i].vCGCoords.y *
                 Element[i].vCGCoords.z);
     }

     // Finally set up the airplane&apos;s mass and its inertia matrix and take the
     // inverse of the inertia matrix
     Airplane.fMass = mass;
     Airplane.mInertia.e11 = Ixx;
     Airplane.mInertia.e12 = -Ixy;
     Airplane.mInertia.e13 = -Ixz;
     Airplane.mInertia.e21 = -Ixy;
     Airplane.mInertia.e22 = Iyy;
     Airplane.mInertia.e23 = -Iyz;
     Airplane.mInertia.e31 = -Ixz;
     Airplane.mInertia.e32 = -Iyz;
     Airplane.mInertia.e33 = Izz;

     Airplane.mInertiaInverse = Airplane.mInertia.Inverse();
}</pre></a><p><a id="I_programlisting6_id332669"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">59</span><span sentence-index="6936" class="highlight3">The  airplane  is  modeled  by  a  number  of  elements,  each  representing  a  different  part  of  the            airplane&apos;s  structure&#x2014;for  example,  the  tail  rudder,  elevators,  wings,  and  fuselage  (see  </span></span></a><a class="xref" href="ch15.html" title="Chapter&#xA0;15.&#xA0;Aircraft"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">60</span><span sentence-index="6937" class="highlight4">Chapter&#xA0;15</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6938</span><span sentence-index="6938" class="highlight2">  for  more  details). </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">62</span><span sentence-index="6939" class="highlight3"> The  code  specified  here  takes  the  mass  properties  of            each  element  and  combines  them,  using  the  techniques  discussed  in  </span></span><a class="xref" href="ch07.html" title="Chapter&#xA0;7.&#xA0;Real-Time Simulations"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">63</span><span sentence-index="6940" class="highlight4">Chapter&#xA0;7</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6941</span><span sentence-index="6941" class="highlight2">  to  come  up  with  the  combined  inertia  tensor  for  the  entire            aircraft. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6942</span><span sentence-index="6942" class="highlight3">  The  important  distinction  between  these  calculations  in  a  3D  simulation  and  the  2D            simulation  is  that  here  the  inertia  is  a  tensor  and  in  2D  it  is  a  single  scalar.</span></span></p><p><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">67</span><span sentence-index="6944" class="highlight4">InitializeAirplane</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6944</span><span sentence-index="6944" class="highlight2">  is  called  at  the  very  start  of  the            program. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6945</span><span sentence-index="6945" class="highlight3">  We  found  it  convenient  to  make  the  call  right  after  the  application&apos;s  main  window  is            created.</span></span></p><p><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6947</span><span sentence-index="6947" class="highlight4">The  final  part  of  the  flight  model  has  to  do  with  calculating  the  forces  and  moments  that            act  on  the  airplane  at  any  given  instant  in  time  during  the  simulation. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6948</span><span sentence-index="6948" class="highlight2">  As  in  the  2D            hovercraft  simulation,  without  this  sort  of  function,  the  airplane  will  do  nothing. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">72</span><span sentence-index="6949" class="highlight3"> For  this            purpose  we&apos;ve  defined  a  function  called  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">72</span><span sentence-index="6949" class="highlight4">CalcAirplaneLoads</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6949</span><span sentence-index="6949" class="highlight2"> ,            which  is  called  at  every  step  through  the  simulation. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span sentence-index="6950" class="highlight3"> This  function  relies  on  a  couple  of            other  functions&#x2014;namely,  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span sentence-index="6950" class="highlight4">LiftCoefficient</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span>,  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span sentence-index="6950" class="highlight3">DragCoefficient</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span sentence-index="6950" class="highlight2">,  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span sentence-index="6950" class="highlight4">RudderLiftCoefficient</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span sentence-index="6950" class="highlight2">,  and  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">73</span><span sentence-index="6950" class="highlight3">RudderDragCoefficient</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6950</span><span sentence-index="6950" class="highlight4"> . </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">74</span><span sentence-index="6951" class="highlight2"> All  of  these  functions  are  shown  and  discussed  in  detail            in  the  section  </span></span><a class="xref" href="ch15.html#modeling" title="Modeling"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">75</span><span sentence-index="6952" class="highlight3">Modeling</span></span></a><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">75</span><span sentence-index="6952" class="highlight4"> in  </span></span><a class="xref" href="ch15.html" title="Chapter&#xA0;15.&#xA0;Aircraft"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">77</span><span sentence-index="6954" class="highlight2">Chapter&#xA0;15</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6954</span><span sentence-index="6954" class="highlight3"> .</span></span></p><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">79</span><span sentence-index="6956" class="highlight4">For  the  most  part,  the  code  contained  in  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">79</span><span sentence-index="6956" class="highlight2">CalcAirplaneLoads</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">79</span><span sentence-index="6956" class="highlight3"> is  similar  to  the  code  you&apos;ve  seen  in  the  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">79</span><span sentence-index="6956" class="highlight4">CalcLoads</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6956</span><span sentence-index="6956" class="highlight2">  function  of  the  hovercraft  simulation. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">80</span><span sentence-index="6957" class="highlight3"> </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">80</span><span sentence-index="6957" class="highlight4">CalcAirplanLoads</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6957</span><span sentence-index="6957" class="highlight2">  is  a  little  more  involved  since  the  airplane  is            modeled  by  a  number  of  elements  that  contribute  to  the  total  lift  and  drag  on  the  airplane. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">81</span><span sentence-index="6958" class="highlight3">           There&apos;s  also  another  difference  that  we&apos;ve  noted  here:</span></span></p><a id="I_programlisting6_id332789"><pre class="programlisting">void     CalcAirplaneLoads(void)
{
     .
     .
     .

     // Convert forces from model space to earth space
     Airplane.vForces = QVRotate(Airplane.qOrientation, Fb);

     // Apply gravity (g is defined as &#x2212;32.174 ft/s^2)
     Airplane.vForces.z += g * Airplane.fMass;

     .
     .
     .
}</pre></a><p><a id="I_programlisting6_id332789"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6961</span><span sentence-index="6961" class="highlight4">Just  about  all  of  the  forces  acting  on  the  airplane  are  first  calculated  in  body-fixed            coordinates  and  then  converted  to  earth-fixed  coordinates  before  the  gravity  force  is  applied. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">85</span><span sentence-index="6962" class="highlight2">           The  coordinate  conversion  is  effected  through  the  use  of  the  function  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">85</span><span sentence-index="6962" class="highlight3">QVRotate</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">85</span><span sentence-index="6962" class="highlight4">,  which  </span></span></a><a id="I_indexterm6_id332808" class="indexterm"></a><a id="I_indexterm6_id332815" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">87</span><span sentence-index="6964" class="highlight2">rotates  the  force  vector  based  on  the  airplane&apos;s  current  orientation,  represented            by  a  </span></span></a><a id="I_indexterm6_id332826" class="indexterm"></a><a id="I_indexterm6_id332836" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6966</span><span sentence-index="6966" class="highlight3">quaternion.</span></span><sup><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">90</span><span sentence-index="6967" class="highlight4">[</span></span></sup></a><a id="CHP-12-FN-1" href="#ftn.CHP-12-FN-1" epub:type="noteref" class="footnote"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">91</span><span sentence-index="6968" class="highlight2">22</span></span></a><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">91</span><span sentence-index="6968" class="highlight3">]</span></span></p></div><div class="sect1" title="Integration"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="integration"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">93</span><span sentence-index="6970" class="highlight4">Integration</span></span></h2></div></div></div><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">94</span><span sentence-index="6971" class="highlight2">Now  that  the  code  to  </span></span><a id="th12.2" class="indexterm"></a><a id="in12.2" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6973</span><span sentence-index="6973" class="highlight3">define,  initialize,  and  calculate  loads  on  the  airplane  is  complete,  you  need  to            develop  the  code  to  actually  integrate  the  equations  of  motion  so  that  the  simulation  can            progress  through  time. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6974</span><span sentence-index="6974" class="highlight4">  The  first  thing  you  need  to  do  is  decide  on  the  integration  scheme  that            you  want  to  use. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">98</span><span sentence-index="6975" class="highlight2"> In  this  example,  we  decided  to  go  with  the  basic  </span></span></a><a id="I_indexterm6_id332915" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6976</span><span sentence-index="6976" class="highlight3">Euler&apos;s  method. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">100</span><span sentence-index="6977" class="highlight4"> We&apos;ve  already  discussed  some  better  methods  in  </span></span></a><a class="xref" href="ch07.html" title="Chapter&#xA0;7.&#xA0;Real-Time Simulations"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">101</span><span sentence-index="6978" class="highlight2">Chapter&#xA0;7</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6979</span><span sentence-index="6979" class="highlight3"> . </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6980</span><span sentence-index="6980" class="highlight4">  We&apos;re  going  with  Euler&apos;s  method  here  because  it&apos;s  simple            and  we  didn&apos;t  want  to  make  the  code  here  overly  complex,  burying  some  key  code  that  we  need  to            point  out  to  you. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">104</span><span sentence-index="6981" class="highlight2"> In  practice,  you&apos;re  better  off  using  one  of  the  other  methods  we  discuss  in                </span></span><a class="xref" href="ch07.html" title="Chapter&#xA0;7.&#xA0;Real-Time Simulations"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">105</span><span sentence-index="6982" class="highlight3">Chapter&#xA0;7</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6983</span><span sentence-index="6983" class="highlight4">  instead  of  Euler&apos;s  method. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">107</span><span sentence-index="6984" class="highlight2"> With  that  said,  we&apos;ve            prepared  a  function  called  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">107</span><span sentence-index="6984" class="highlight3">StepSimulation</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">107</span><span sentence-index="6984" class="highlight4"> that  handles  all            of  the  integration  necessary  to  actually  propagate  the  simulation:</span></span></p><a id="I_programlisting6_id332947"><pre class="programlisting">void     StepSimulation(float dt)
{
     // Take care of translation first:
     // (If this body were a particle, this is all you would need to do.)

          Vector Ae;

          // calculate all of the forces and moments on the airplane:
          CalcAirplaneLoads();

          // calculate the acceleration of the airplane in earth space:
          Ae = Airplane.vForces / Airplane.fMass;

          // calculate the velocity of the airplane in earth space:
          Airplane.vVelocity += Ae * dt;

          // calculate the position of the airplane in earth space:
          Airplane.vPosition += Airplane.vVelocity * dt;


     // Now handle the rotations:
          float  mag;

          // calculate the angular velocity of the airplane in body space:
          Airplane.vAngularVelocity += Airplane.mInertiaInverse *
                                       (Airplane.vMoments -
                                       (Airplane.vAngularVelocity^
                                       (Airplane.mInertia *
                                         Airplane.vAngularVelocity)))
                                        * dt;

          // calculate the new rotation quaternion:
          Airplane.qOrientation += (Airplane.qOrientation *
                                    Airplane.vAngularVelocity) *
                                   (0.5f * dt);

          // now normalize the orientation quaternion:
          mag = Airplane.qOrientation.Magnitude();
          if (mag != 0)
               Airplane.qOrientation /= mag;

          // calculate the velocity in body space:
          // (we&apos;ll need this to calculate lift and drag forces)
          Airplane.vVelocityBody = QVRotate(~Airplane.qOrientation,
                                            Airplane.vVelocity);

          // calculate the air speed:
          Airplane.fSpeed = Airplane.vVelocity.Magnitude();

          // get the Euler angles for our information
          Vector u;

          u = MakeEulerAnglesFromQ(Airplane.qOrientation);
          Airplane.vEulerAngles.x = u.x;     // roll
          Airplane.vEulerAngles.y = u.y;     // pitch
          Airplane.vEulerAngles.z = u.z;     // yaw

}</pre><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">109</span><span sentence-index="6986" class="highlight2">The  very  first  thing  that  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">109</span><span sentence-index="6986" class="highlight3">StepSimulation</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">109</span><span sentence-index="6986" class="highlight4"> does  is  call                </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">109</span><span sentence-index="6986" class="highlight2">CalcAirplaneLoads</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6986</span><span sentence-index="6986" class="highlight3">  to  calculate  the  loads  acting  on  the            airplane  at  the  current  instant  in  time. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">110</span><span sentence-index="6987" class="highlight4"> </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">110</span><span sentence-index="6987" class="highlight2">StepSimulation</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6987</span><span sentence-index="6987" class="highlight3">            then  goes  on  to  calculate  the  linear  acceleration  of  the  airplane  based  on  current  loads. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6988</span><span sentence-index="6988" class="highlight4">            Next,  the  function  goes  on  to  integrate,  using  Euler&apos;s  method,  once  to  calculate  the            airplane&apos;s  linear  velocity  and  then  a  second  time  to  calculate  the  airplane&apos;s  position. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6989</span><span sentence-index="6989" class="highlight2">  As            we&apos;ve  commented  in  the  code,  if  you  were  simulating  a  particle  this  is  all  you  would  have  to            do;  however,  since  this  is  not  a  particle,  you  need  to  handle  angular  motion.</span></span></p></a><p><a id="I_programlisting6_id332947"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">115</span><span sentence-index="6992" class="highlight3">The  first  step  in  handling  angular  motion  is  to  calculate  the  new  </span></span></a><a id="I_indexterm6_id332998" class="indexterm"></a><a id="I_indexterm6_id333010" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6994</span><span sentence-index="6994" class="highlight4">angular  velocity  at  this  time  step,  using  Euler  integration,  based  on  the            previously  calculated  moments  acting  on  the  airplane  and  its  mass  properties. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight2 nonQuoteStr"> We  do  this  in            body  coordinates  using  the  following  equation  of  angular  motion  but  rewritten  to  solve  for                </span></span><span class="emphasis"><em><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight3 nonQuoteStr">d</span></span></em></span><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight4 nonQuoteStr">&#x3C9;:</span></span></a></p><table style="border: 0; " class="simplelist"><tbody><tr><td><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight2 nonQuoteStr">&#x2211;  </span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight3 nonQuoteStr">M</span></span></strong></span><sub><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span>cg</span></span></sub><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight2 nonQuoteStr"> =  d</span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight3 nonQuoteStr">H</span></span></strong></span><sub><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight4 nonQuoteStr">cg</span></span></sub><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight4 nonQuoteStr">/dt  =  </span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight2 nonQuoteStr">I</span></span></strong></span><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight3 nonQuoteStr"> (d</span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span>&#x3C9;</span></span></strong></span><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight2 nonQuoteStr">/dt)  +  (</span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight4 nonQuoteStr">&#x3C9;</span></span></strong></span><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight3 nonQuoteStr"> &#xD7;  (</span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight4 nonQuoteStr">I  &#x3C9;</span></span></strong></span><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">118</span><span sentence-index="6995" class="highlight2 nonQuoteStr">))</span></span></td></tr></tbody></table><p><a id="I_indexterm6_id333010" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">120</span><span sentence-index="6997" class="highlight3">The  next  step  is  to  integrate  again  to  update  the  </span></span></a><a id="I_indexterm6_id333082" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">6998</span><span sentence-index="6998" class="highlight4">airplane&apos;s  orientation,  which  is  expressed  as  a  quaternion. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">122</span><span sentence-index="6999" class="highlight2"> Here,  you  need  to  use            the  differential  equation  relating  an  orientation  quaternion  to  angular  velocity  that  we            showed  you  in  </span></span></a><a class="xref" href="ch11.html" title="Chapter&#xA0;11.&#xA0;Rotation in 3D Rigid-Body Simulators"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">123</span><span sentence-index="7000" class="highlight3">Chapter&#xA0;11</span></span></a><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">123</span><span sentence-index="7000" class="highlight4">:</span></span></p><table style="border: 0; " class="simplelist"><tbody><tr><td><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">123</span><span sentence-index="7000" class="highlight2">d</span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">123</span><span sentence-index="7000" class="highlight3">q</span></span></strong></span><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">123</span><span sentence-index="7000" class="highlight4">/dt  =  (1/2)  </span></span><span class="strong"><strong><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">123</span><span sentence-index="7000" class="highlight2">&#x3C9;                    q</span></span></strong></span></td></tr></tbody></table><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">125</span><span sentence-index="7002" class="highlight3">Next,  to  enforce  the  constraint  that  this  orientation  quaternion  be</span></span><a id="I_indexterm6_id333124" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">126</span><span sentence-index="7003" class="highlight4"> a  </span></span><span class="emphasis"><em><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">126</span><span sentence-index="7003" class="highlight2">unit</span></span></em></span><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7004</span><span sentence-index="7004" class="highlight3">  quaternion,  the  function  goes  ahead  and  normalizes            the  orientation  quaternion.</span></span></a></p><p><a id="I_indexterm6_id333124" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">130</span><span sentence-index="7007" class="highlight4">Since  the  linear  velocity  was  previously  calculated  in  global  coordinates  (the  fixed            coordinate  system),  and  since  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">130</span><span sentence-index="7007" class="highlight2">CalcAirplaneLoads</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">130</span><span sentence-index="7007" class="highlight3"> needs  the            velocity  in  the  body-fixed  (rotating)  coordinates  system,  the  function  goes  ahead  and  rotates            the  velocity  vector,  storing  the  body-fixed  vector  in  the  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">130</span><span sentence-index="7007" class="highlight4">vVelocityBody</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">130</span><span sentence-index="7007" class="highlight2"> member  of  the  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">130</span><span sentence-index="7007" class="highlight3">RigidBody</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7007</span><span sentence-index="7007" class="highlight4">            structure. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">131</span><span sentence-index="7008" class="highlight2"> This  is  done  here  as  a  matter  of  convenience  and  uses  the  quaternion  rotation            function  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">131</span><span sentence-index="7008" class="highlight3">QVRotate</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7008</span><span sentence-index="7008" class="highlight4">  to  rotate  the  vector  based  on  the            airplane&apos;s  current  orientation. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7009</span><span sentence-index="7009" class="highlight2">  Notice  here  that  we  use  the  conjugate  of  the  orientation            quaternion  since  we&apos;re  now  rotating  from  global  coordinates  to  body  coordinates.</span></span></a></p><p><a id="I_indexterm6_id333124" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7012</span><span sentence-index="7012" class="highlight3">As  another  convenience,  we  calculate  the  air  speed,  which  is  simply  the  magnitude  of  the            linear  velocity  vector. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7013</span><span sentence-index="7013" class="highlight4">  This  is  used  to  report  the  air  speed  in  the  main  window  title            bar.</span></span></a></p><p><a id="I_indexterm6_id333124" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7016</span><span sentence-index="7016" class="highlight2">Lastly,  the  three  Euler  angles&#x2014;roll,  pitch,  and  yaw&#x2014;are  extracted  from  the  orientation            quaternion  so  that  they  can  also  be  reported  in  the  main  window  title  bar. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">140</span><span sentence-index="7017" class="highlight3"> The  function  to  use            here  </span></span></a><a id="I_indexterm6_id333178" class="indexterm"></a><a id="I_indexterm6_id333189" class="indexterm"></a><a id="I_indexterm6_id333195" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">143</span><span sentence-index="7020" class="highlight4">is  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">143</span><span sentence-index="7020" class="highlight2">MakeEulerAnglesFromQ</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">143</span><span sentence-index="7020" class="highlight3">,  which  is  defined  in                </span></span></a><a class="xref" href="apc.html" title="Appendix&#xA0;C.&#xA0;Quaternion Operations"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">144</span><span sentence-index="7021" class="highlight4">Appendix&#xA0;C</span></span></a><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7022</span><span sentence-index="7022" class="highlight2"> .</span></span></p><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">147</span><span sentence-index="7024" class="highlight3 nonQuoteStr">Don&apos;t  forget,  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">147</span><span sentence-index="7024" class="highlight4 nonQuoteStr">StepSimulation</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">147</span><span sentence-index="7024" class="highlight2 nonQuoteStr"> must  be  called  once  per                </span></span><a id="I_indexterm6_id333227" class="indexterm"></a><a id="I_indexterm6_id333236" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7026</span><span sentence-index="7026" class="highlight3">simulation  cycle.</span></span></a></p></div><div class="sect1" title="Flight Controls"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="flight_controls"><a id="I_indexterm6_id333236" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">152</span><span sentence-index="7029" class="highlight4">Flight  Controls</span></span></a></h2></div></div></div><p><a id="I_indexterm6_id333236" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">154</span><span sentence-index="7031" class="highlight2">At  this  point,  the  </span></span></a><a id="th12.3" class="indexterm"></a><a id="fl12.3" class="indexterm"></a><a id="ai12.3" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7034</span><span sentence-index="7034" class="highlight3">simulation  still  won&apos;t  work  very  well  because  you  have  not  implemented  the  flight            controls. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7035</span><span sentence-index="7035" class="highlight4">  The  flight  controls  allow  you  to  interact  with  the  airplane&apos;s  various  controls            surfaces  in  order  to  actually  fly  the  plane. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7036</span><span sentence-index="7036" class="highlight2">  We&apos;ll  use  the  keyboard  as  the  main  input  device            for  the  flight  controls. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7037</span><span sentence-index="7037" class="highlight3">  Remember,  in  a  physics-based  simulation  such  as  this  one,  you  don&apos;t            directly  control  the  motion  of  the  airplane;  you  control  only  how  various  forces  are  applied            to  the  airplane,  which  then,  by  integration  over  time,  affect  the  airplane&apos;s  motion.</span></span></a></p><p><a id="ai12.3" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7040</span><span sentence-index="7040" class="highlight4">For  this  simulation,  the  flight  stick  is  simulated  by  the  arrow  keys. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">164</span><span sentence-index="7041" class="highlight2"> The  down  arrow  pulls            back  on  the  stick,  raising  the  nose;  the  up  arrow  pushes  the  stick  forward,  causing  the  nose            to  dive;  the  left  arrow  rolls  the  plane  to  the  left  (port  side);  and  the  right  arrow  </span></span></a><a id="I_indexterm6_id333318" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7042</span><span sentence-index="7042" class="highlight3">rolls  the  plane  to  the  right  (starboard  side). </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">166</span><span sentence-index="7043" class="highlight4"> The  X  key  applies  left  rudder            action  to  cause  the  nose  of  the  plane  to  yaw  toward  the  left,  while  the  C  key  applies  right            rudder  action  to  cause  the  nose  to  </span></span></a><a id="I_indexterm6_id333330" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7044</span><span sentence-index="7044" class="highlight2">yaw  toward  the  right. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">168</span><span sentence-index="7045" class="highlight3"> Thrust  is  </span></span></a><a id="I_indexterm6_id333342" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7046</span><span sentence-index="7046" class="highlight4">controlled  by  the  A  and  Z  keys. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7047</span><span sentence-index="7047" class="highlight2">  The  A  key  increments  the  propeller  thrust  by  100            pounds,  and  the  Z  key  decrements  the  thrust  by  100  pounds. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7048</span><span sentence-index="7048" class="highlight3">  The  minimum  thrust  is  0,  while  the            maximum  available  thrust  is  3,000  pounds. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7049</span><span sentence-index="7049" class="highlight4">  The  F  key  activates  the  landing  flaps  to  increase            lift  at  low  speed,  while  the  D  key  deactivates  the  landing  flaps.</span></span></a></p><p><a id="I_indexterm6_id333342" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">175</span><span sentence-index="7052" class="highlight2">We  control  pitch  </span></span></a><a id="I_indexterm6_id333359" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7053</span><span sentence-index="7053" class="highlight3">by  deflecting  the  flaps  on  the  aft  elevators;  for  example,  to  pitch  the  nose  up,            we  deflect  the  aft  elevator  flaps  upward  (that  is,  the  trailing  edge  of  the  elevator  is  raised            with  respect  to  the  leading  edge). </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7054</span><span sentence-index="7054" class="highlight4">  We  control  roll  in  this  simulation  by  applying  the  flaps            differentially;  for  example,  to  roll  right,  we  deflect  the  right  flap  upward  and  the  left  flap            downward. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7055</span><span sentence-index="7055" class="highlight2">  Finally,  we  control  yaw  by  deflecting  the  vertical  tail  rudder;  for  example,  to  yaw            left,  we  deflect  the  trailing  edge  of  the  tail  rudder  toward  the  left.</span></span></a></p><p><a id="I_indexterm6_id333359" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7058</span><span sentence-index="7058" class="highlight3">We&apos;ve  prepared  several  functions  to  handle  the  flight  controls  that  should  be  called            whenever  the  user  is  pressing  one  of  the  flight  control  keys. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">182</span><span sentence-index="7059" class="highlight4"> There  are  two  functions  for  the            propeller  thrust:</span></span></a></p><a id="I_programlisting6_id333382"><pre class="programlisting">void     IncThrust(void)
{
     ThrustForce += _DTHRUST;
     if(ThrustForce &gt; _MAXTHRUST)
          ThrustForce = _MAXTHRUST;
}

void     DecThrust(void)
{
     ThrustForce -= _DTHRUST;
     if(ThrustForce &lt; 0)
          ThrustForce = 0;
}</pre><p><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">184</span><span sentence-index="7061" class="highlight2">IncThrust</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">184</span><span sentence-index="7061" class="highlight3"> simply  increases  the  thrust  by  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">184</span><span sentence-index="7061" class="highlight4">_DTHRUST</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">184</span><span sentence-index="7061" class="highlight2"> checking  to  make  sure  it  does  not  exceed  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">184</span><span sentence-index="7061" class="highlight3">_MAXTHRUST</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7061</span><span sentence-index="7061" class="highlight4"> . </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">185</span><span sentence-index="7062" class="highlight2"> We&apos;ve  defined  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">185</span><span sentence-index="7062" class="highlight3">_DTHRUST</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">185</span><span sentence-index="7062" class="highlight4"> and  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">185</span><span sentence-index="7062" class="highlight2">_MAXTHRUST</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">185</span><span sentence-index="7062" class="highlight3"> as  follows:</span></span></p></a><a id="I_programlisting6_id333422"><pre class="programlisting">#define    _DTHRUST      100.0f
#define    _MAXTHRUST    3000.0f</pre><p><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">187</span><span sentence-index="7064" class="highlight4">DecThrust</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">187</span><span sentence-index="7064" class="highlight2">,  on  the  other  hand,  decreases  the  thrust  by                </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">187</span><span sentence-index="7064" class="highlight3">_DTHRUST</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7064</span><span sentence-index="7064" class="highlight4">  checking  to  make  sure  it  does  not  fall  below            0.</span></span></p><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">189</span><span sentence-index="7066" class="highlight2 nonQuoteStr">To  control  yaw,  we&apos;ve  prepared  three  functions  that  manipulate  the  rudder:</span></span></p></a><a id="I_programlisting6_id333447"><pre class="programlisting">void     LeftRudder(void)
{
     Element[6].fIncidence = 16;
}

void     RightRudder(void)
{
     Element[6].fIncidence = &#x2212;16;
}

void     ZeroRudder(void)
{
     Element[6].fIncidence = 0;
}</pre><p><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">191</span><span sentence-index="7068" class="highlight3">LeftRudder</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">191</span><span sentence-index="7068" class="highlight4"> changes  the  incidence  angle  of  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">191</span><span sentence-index="7068" class="highlight2">Element[6]</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">191</span><span sentence-index="7068" class="highlight3">,  the  vertical  tail  rudder,  to  16  degrees,  while                </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">191</span><span sentence-index="7068" class="highlight4">RightRudder</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7068</span><span sentence-index="7068" class="highlight2">  changes  the  incidence  angle  to  &#x2212;16  degrees. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">192</span><span sentence-index="7069" class="highlight3">               </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">192</span><span sentence-index="7069" class="highlight4">ZeroRudder</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7069</span><span sentence-index="7069" class="highlight2">  centers  the  rudder  at  0  degrees.</span></span></p></a><p><a id="I_programlisting6_id333447"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">195</span><span sentence-index="7072" class="highlight3">The  ailerons,  or  flaps,  are  </span></span></a><a id="I_indexterm6_id333485" class="indexterm"></a><a id="I_indexterm6_id333492" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">197</span><span sentence-index="7074" class="highlight4">manipulated  by  these  functions  to  control  roll:</span></span></a></p><a id="I_programlisting6_id333500"><pre class="programlisting">void     RollLeft(void)
{
     Element[0].iFlap = 1;
     Element[3].iFlap = &#x2212;1;
}

void     RollRight(void)
{
     Element[0].iFlap = &#x2212;1;
     Element[3].iFlap = 1;
}

void     ZeroAilerons(void)
{
     Element[0].iFlap = 0;
     Element[3].iFlap = 0;
}</pre><p><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">199</span><span sentence-index="7076" class="highlight2">RollLeft</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">199</span><span sentence-index="7076" class="highlight3"> deflects  the  port  aileron,  located  on  the  port            wing  section  (</span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">199</span><span sentence-index="7076" class="highlight4">Element[0]</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">199</span><span sentence-index="7076" class="highlight2">),  upward,  and  the  starboard            aileron,  located  on  the  starboard  wing  section  (</span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">199</span><span sentence-index="7076" class="highlight3">Element[3]</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7076</span><span sentence-index="7076" class="highlight4"> ),  downward. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">200</span><span sentence-index="7077" class="highlight2"> </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">200</span><span sentence-index="7077" class="highlight3">RollRight</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">200</span><span sentence-index="7077" class="highlight4"> does  just  the            opposite,  and  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">200</span><span sentence-index="7077" class="highlight2">ZeroAilerons</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7077</span><span sentence-index="7077" class="highlight3">  resets  the  flaps  back  to  their            undeflected  positions.</span></span></p></a><p><a id="I_programlisting6_id333500"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">203</span><span sentence-index="7080" class="highlight4">We&apos;ve  defined  yet  another  set  of  functions  to  control  the  aft  </span></span></a><a id="I_indexterm6_id333544" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">204</span><span sentence-index="7081" class="highlight2">elevators  so  as  to  control  </span></span></a><a id="I_indexterm6_id333553" class="indexterm"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">206</span><span sentence-index="7083" class="highlight3">pitch:</span></span></a></p><a id="I_programlisting6_id333565"><pre class="programlisting">void     PitchUp(void)
{
     Element[4].iFlap = 1;
     Element[5].iFlap = 1;
}

void     PitchDown(void)
{
     Element[4].iFlap = &#x2212;1;
     Element[5].iFlap = &#x2212;1;
}


void     ZeroElevators(void)
{
     Element[4].iFlap = 0;
     Element[5].iFlap = 0;
}</pre><p><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">208</span><span sentence-index="7085" class="highlight4">Element[4]</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">208</span><span sentence-index="7085" class="highlight2"> and  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">208</span><span sentence-index="7085" class="highlight3">Element[5]</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7085</span><span sentence-index="7085" class="highlight4">  are  the  elevators. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">209</span><span sentence-index="7086" class="highlight2"> </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">209</span><span sentence-index="7086" class="highlight3">PitchUp</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">209</span><span sentence-index="7086" class="highlight4"> deflects            their  flaps  upward,  and  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">209</span><span sentence-index="7086" class="highlight2">PitchDown</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7086</span><span sentence-index="7086" class="highlight3">  deflects  their  flaps            downward. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">210</span><span sentence-index="7087" class="highlight4"> </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">210</span><span sentence-index="7087" class="highlight2">ZeroElevators</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7087</span><span sentence-index="7087" class="highlight3">  resets  their  flaps  back  to  their            undeflected  positions.</span></span></p><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">212</span><span sentence-index="7089" class="highlight4">Finally,  there  are  two  more  functions  to  control  the  landing  flaps:</span></span></p></a><a id="I_programlisting6_id333610"><pre class="programlisting">void     FlapsDown(void)
{
     Element[1].iFlap = &#x2212;1;
     Element[2].iFlap = &#x2212;1;
     Flaps = true;
}

void     ZeroFlaps(void)
{
     Element[1].iFlap = 0;
     Element[2].iFlap = 0;
     Flaps = false;
}</pre><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">214</span><span sentence-index="7091" class="highlight2">The  landing  flaps  are  fitted  on  the  inboard  wings  sections,  port  and  starboard,  which  are                </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">214</span><span sentence-index="7091" class="highlight3">Element[1]</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">214</span><span sentence-index="7091" class="highlight4"> and  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">214</span><span sentence-index="7091" class="highlight2">Element[2]</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7091</span><span sentence-index="7091" class="highlight3"> . </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">215</span><span sentence-index="7092" class="highlight4"> </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">215</span><span sentence-index="7092" class="highlight2">FlapsDown</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">215</span><span sentence-index="7092" class="highlight3"> deflects  the  flaps            downward,  while  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">215</span><span sentence-index="7092" class="highlight4">ZeroFlaps</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7092</span><span sentence-index="7092" class="highlight2">  resets  them  back  to  their            undeflected  position.</span></span></p><p><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7094</span><span sentence-index="7094" class="highlight3">As  we  said,  these  functions  should  be  called  when  the  user  is  pressing  the  flight  control            keys. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">218</span><span sentence-index="7095" class="highlight4"> Further,  they  need  to  be  called  before  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">218</span><span sentence-index="7095" class="highlight2">StepSimulation</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7095</span><span sentence-index="7095" class="highlight3">            is  called  so  that  they  can  be  included  in  the  current  time  step&apos;s  force  and  moment            calculations. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">219</span><span sentence-index="7096" class="highlight4"> The  sequence  of  calls  should  look  something  like  this:</span></span></p></a><a id="I_programlisting6_id333659"><pre class="programlisting">.
.
.

     ZeroRudder();
     ZeroAilerons();
     ZeroElevators();

     // pitch down
     if (IsKeyDown(VK_UP))
          PitchDown();

     // pitch up
     if (IsKeyDown(VK_DOWN))
          PitchUp();

     // roll left
     if (IsKeyDown(VK_LEFT))
          RollLeft();

     // roll right
     if (IsKeyDown(VK_RIGHT))
          RollRight();

     //  Increase thrust
     if (IsKeyDown(0x41)) // A
          IncThrust();

     //  Decrease thrust
     if (IsKeyDown(0x5A)) // Z
          DecThrust();

     // yaw left
     if (IsKeyDown(0x58)) // x
          LeftRudder();

     // yaw right
     if (IsKeyDown(0x43)) // c
          RightRudder();

     // landing flaps down
     if (IsKeyDown(0x46)) //f
          FlapsDown();

     // landing flaps up
     if (IsKeyDown(0x44)) // d
          ZeroFlaps();

     StepSimulation(dt);
.
.
.</pre><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">221</span><span sentence-index="7098" class="highlight2">Before  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">221</span><span sentence-index="7098" class="highlight3">StepSimulation</span></span></code><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7098</span><span sentence-index="7098" class="highlight4">  is  called,  we  check  each  of  the            flight  control  keys  to  see  if  it  is  being  pressed. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7099</span><span sentence-index="7099" class="highlight2">  If  so,  then  the  appropriate  function  is            called.</span></span></p><p><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">224</span><span sentence-index="7101" class="highlight3 nonQuoteStr">The  function  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">224</span><span sentence-index="7101" class="highlight4 nonQuoteStr">IsKeyDown</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">224</span><span sentence-index="7101" class="highlight2 nonQuoteStr">,  which  checks  whether  a  certain            key  is  pressed,  looks  like  this  in  a  Windows  implementation:</span></span></p></a><a id="I_programlisting6_id333693"><pre class="programlisting">BOOL IsKeyDown(short KeyCode)
{

    SHORT    retval;

    retval = GetAsyncKeyState(KeyCode);

    if (HIBYTE(retval))
        return TRUE;

    return FALSE;
}</pre><p><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7103</span><span sentence-index="7103" class="highlight3">The  important  thing  to  note  here  is  that  the  keys  are  being  checked  asynchronously  because            it  is  possible  that  more  than  one  key  will  be  pressed  at  any  given  time,  and  they  must  be            handled  simultaneously  instead  of  one  at  a  time  (as  would  be  the  case  in  the  standard  Windows            message  processing  function).</span></span></p></a><p><a id="I_programlisting6_id333693"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7106</span><span sentence-index="7106" class="highlight4">The  addition  of  flight  control  code  pretty  much  completes  the  physics  part  of  the            simulation. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7107</span><span sentence-index="7107" class="highlight2">  So  far,  you  have  the  model,  the  integrator,  and  the  user  input  or  flight  control            elements  completed. </span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7108</span><span sentence-index="7108" class="highlight3">  All  that  remains  is  setting  up  the  application&apos;s  main  window  and  actually            drawing  something  that  represents  what  you&apos;re  simulating. </span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">232</span><span sentence-index="7109" class="highlight4"> We&apos;ll  leave  that  part  up  to  you,  or            you  can  look  at  the  example  we&apos;ve  included  on  the  book&apos;s  website  to  see  what  we  did  on  a            Windows  </span></span></a><a id="I_indexterm6_id333714" class="indexterm"></a><a id="I_indexterm6_id333723" class="indexterm"></a><a id="I_indexterm6_id333733" class="indexterm"></a><a id="I_indexterm6_id333742" class="indexterm"></a><a id="I_indexterm6_id333751" class="indexterm"><span class="nonQuoteStr"><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7114</span><span sentence-index="7114" class="highlight2">machine.</span></span></a></p></div><div class="footnotes" epub:type="footnotes"><a id="I_indexterm6_id333751" class="indexterm"><br><hr style="width: 100; align: left;"></a><div class="footnote" epub:type="footnote" id="ftn.CHP-12-FN-1"><a id="I_indexterm6_id333751" class="indexterm"></a><p><a id="I_indexterm6_id333751" class="indexterm"><sup><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">243</span><span sentence-index="7120" class="highlight3">[</span></span></sup></a><a href="#CHP-12-FN-1" class="para"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">244</span><span sentence-index="7121" class="highlight4">22</span></span></a><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">244</span><span sentence-index="7121" class="highlight2">]  </span></span><code class="literal"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">244</span><span sentence-index="7121" class="highlight3">QVRotate</span></span></code><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">244</span><span sentence-index="7121" class="highlight4"> is  defined  in  </span></span><a class="xref" href="apc.html" title="Appendix&#xA0;C.&#xA0;Quaternion Operations"><span><span style="background-color: lightgray; padding: 4px;" class="spanSentenceIndexNumber">246</span><span sentence-index="7123" class="highlight2">Appendix&#xA0;C</span></span></a><span><span style="margin-right: 5px; margin-left: 5px;" class="spanSentenceIndexNumber">7123</span><span sentence-index="7123" class="highlight3"> .</span></span></p></div></div></section>
</body></html>